<!--
# (c) Copyright Jupyter Development Team
# (c) Copyright IBM Corp. 2016
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../urth-core-behaviors/error-display-behavior.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">

<script src="../requirejs/require.js"></script>

<!--
A widget that uses vega-lite to render a visualization

Example:

```html
<urth-viz-vega></urth-viz-vega>
```

@group Urth Viz
@element urth-viz-vega
-->
<dom-module id="urth-viz-vega">
    <template>
        <style>
          :host {
          }
        </style>
        <div id="container">
        </div>
        <content></content>
    </template>

    <script>
    (function () {
        'use strict';
        var requireConfigured;

        Polymer({
            is: 'urth-viz-vega',
            properties: {
                mode: {
                    type: String,
                    value: 'vega-lite'
                },
                spec: {
                    type: Object,
                    observer: '_specChanged'
                }
            },

            behaviors: [
                Polymer.IronResizableBehavior,
                Urth.DisplayErrorBehavior
            ],

            listeners: {
                'iron-resize': '_resize'
            },

            _specChanged: function(newSpec) {
                if (!newSpec || !this.view) { return; }

                this.$.container.innerHTML = '';
                this.render();
            },

            _resize: function() {
                if (!this.view) { return; }

                // TODO
                this.view.update();
            },

            created: function() {
                // Need the relative paths based on the
                // location of this Polymer element. This has to be done
                // inside the element to get the proper path. Calling
                // resolveUrl outside of the element's methods returns
                // the incorrect path. Only want to do this once and not
                // for each instance so a global is used to track.
                if (!requireConfigured) {
                    requirejs.config({
                        paths: {
                            d3: this.resolveUrl('../d3/d3'),
                            d3_geo_projection: 'http://cdnjs.cloudflare.com/ajax/libs/d3-geo-projection/0.2.16/d3.geo.projection.min',
                            d3_layout_cloud: 'http://vega.github.io/vega-editor/vendor/d3.layout.cloud',
                            topojson: 'http://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.20/topojson.min',
                            vega: this.resolveUrl('../vega/vega'),
                            vega_embed: this.resolveUrl('../vega-embed/vega-embed'),
                            vega_lite: this.resolveUrl('../vega-lite/vega-lite'),
                        },
                        shim: {
                            d3: {
                                exports: 'd3'
                            },
                            d3_geo_projection: {deps: ['d3']},
                            d3_layout_cloud: {deps: ['d3']},
                            vega: {
                                deps: ['d3', 'd3_geo_projection', 'd3_layout_cloud', 'topojson'],
                                exports: 'vg'
                            },
                            vega_lite: {
                                deps: ['vega'],
                                exports: 'vl'
                            },
                            vega_embed: {
                                deps: ['vg.global', 'vl.global']
                            }
                        }
                    });

                    define('vg.global', ['vega'], function(vgGlobal) {
                        window.vg = vgGlobal;
                    });

                    define('vl.global', ['vega_lite'], function(vlGlobal) {
                        window.vl = vlGlobal;
                    });

                    requireConfigured = true;
                }
            },

            ready: function() {
                var display = window.getComputedStyle(this).display;
                if (display === 'none' || document.readyState !== 'complete') {
                    this.async(this.ready, 200);
                    return;
                }

                this.render();
            },

            render: function() {
                require(['vega_embed'], function(embed) {
                    embed(this.$.container, { mode: this.mode, spec: this.spec, renderer: 'svg', actions: false }, function(err, result) {
                        if (err) {
                            this.displayErrorMessage('urth-viz-vega: error loading visual: ' + err);
                        } else {
                            this.view = result.view;
                            this.fire('urth-viz-render');
                        }
                    }.bind(this));
                }.bind(this));
            }
        });
    })();
    </script>
</dom-module>
